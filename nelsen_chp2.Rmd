---
title: "Nelsen Intro to copulas - Chp 2"
output:
  html_document:
    toc: no
    toc_depth: 3
    number_sections: false
    code_folding: hide
    theme: paper
code_folding: hide
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(copBasic)
library(lattice) # for wireframe
library(rgl) # for persp3d, etc
library(magrittr)
```

## 2.1 Preliminaries

### Ex 2.1 

```{r ex2.1, cache=TRUE}
#H volume generator function 
mk_Hvol<-function(fun=NULL){
  
  function(x,y){
    fun(x[2],y[2])-fun(x[2],y[1])-fun(x[1],y[2])+fun(x[1],y[1])
  }
  
}

# make vectorized function
H1<-function(x,y) mapply(function(x,y) max(x,y),x,y)

# create H-volume function
H1_vol<-mk_Hvol(fun=H1)

#H1_vol(c(0,1),c(0,1))

x<-y<-seq(0,1,length=50)
z1<-outer(x,y,FUN="H1") #same as outer(x,y,FUN="pmax")

# color scheme
num_col<-100
#color <- heat.colors(num_col)
color <- rev(rainbow(num_col, start = 0/6, end = 4/6))


if(0){
wireframe(z1, drape=TRUE)
wireframe(z1, drape=TRUE,screen=list(z=30, x=-60))
wireframe(z1, drape=TRUE,screen=list(z=20, x=-60))
wireframe(z1, drape=TRUE,screen=list(z=20, x=-80))
wireframe(z1, drape=TRUE,screen=list(z=30, x=-80))

persp(x,y,z1)
}

```

The H-volume for $H(x,y)=\max(x,y)$ is `r H1_vol(c(0,1),c(0,1))`, so this function is *not* 2-increasing.

```{r ex2.1plta, cache=TRUE, fig.pos="center", fig.cap="Contour plot"}
contour(x,y,z1)
```

```{r ex2.1pltb, cache=TRUE, fig.pos="center", fig.cap="Color image"}
image(x,y,z1,col=color)
```

```{r, include=FALSE}
movie3d_mod<-function (f, duration, dev = rgl.cur(), ..., fps = 10, movie = "movie", 
    frames = movie, dir = tempdir(), convert = NULL, clean = TRUE, 
    verbose = TRUE, top = TRUE, type = "gif", startTime = 0, loops=0) 
{
    olddir <- setwd(dir)
    on.exit(setwd(olddir))
    for (i in round(startTime * fps):(duration * fps)) {
        time <- i/fps
        if (rgl.cur() != dev) 
            rgl.set(dev)
        stopifnot(rgl.cur() != 0)
        args <- f(time, ...)
        subs <- args$subscene
        if (is.null(subs)) 
            subs <- currentSubscene3d(dev)
        else args$subscene <- NULL
        for (s in subs) par3d(args, subscene = s)
        filename <- sprintf("%s%03d.png", frames, i)
        if (verbose) {
            cat(gettextf("Writing '%s'\r", filename))
            flush.console()
        }
        rgl.snapshot(filename = filename, fmt = "png", top = top)
    }
    cat("\n")
    if (.Platform$OS.type == "windows") 
        system <- shell
    if (is.null(convert) && requireNamespace("magick")) {
        m <- NULL
        for (i in round(startTime * fps):(duration * fps)) {
            filename <- sprintf("%s%03d.png", frames, i)
            frame <- magick::image_read(filename)
            if (is.null(m)) 
                m <- frame
            else m <- c(m, frame)
            if (clean) 
                unlink(filename)
        }
        m <- magick::image_animate(m, fps = fps, loop = loops, dispose = "previous")
        magick::image_write(m, paste0(movie, ".", type))
        return(invisible(m))
    }
    else if (is.null(convert)) {
        warning("R package 'magick' is not installed; trying external package.")
        convert <- TRUE
    }
    if (is.logical(convert) && convert) {
        progname <- "magick"
        version <- try(system2(progname, "--version", stdout = TRUE, 
            stderr = TRUE), silent = TRUE)
        if (inherits(version, "try-error") || !length(grep("ImageMagick", 
            version))) {
            progname <- "convert"
            version <- try(system2(progname, "--version", stdout = TRUE, 
                stderr = TRUE), silent = TRUE)
        }
        if (inherits(version, "try-error") || !length(grep("ImageMagick", 
            version))) 
            stop("'ImageMagick' not found")
        filename <- paste0(movie, ".", type)
        if (verbose) 
            cat(gettextf("Will create: %s\n", file.path(dir, 
                filename)))
        convert <- paste(progname, "-delay 1x%d %s*.png %s.%s")
    }
    if (is.character(convert)) {
        convert <- sprintf(convert, fps, frames, movie, type, 
            duration, dir)
        if (verbose) {
            cat(gettextf("Executing: '%s'\n", convert))
            flush.console()
        }
        system(convert)
        if (clean) {
            if (verbose) 
                cat(gettext("Deleting frames\n"))
            for (i in 0:(duration * fps)) {
                filename <- sprintf("%s%03d.png", frames, i)
                unlink(filename)
            }
        }
    }
    invisible(convert)
}


```

```{r ex2.1pltc, cache=TRUE}
zcol <- cut(z1, num_col)
persp3d(x,y,z1, col=color[zcol])
movie3d_mod(spin3d(axis = c(0, 0, 1), rpm = 6), duration = 10, 
        movie="ex1",dir=file.path(getwd(),"fig") )
#play3d(spin3d(axis = c(0, 0, 1), rpm = 6), duration = 10)
```

![Ex 2.1 gif of H(x,y)=max(x,y)](fig/ex1.gif)

### Ex 2.2

```{r ex2.2, cache=TRUE}
# make vectorized function
H2<-function(x,y) mapply(function(x,y) (2*x-1)*(2*y-1), x,y)

# create H-volume function
H2_vol<-mk_Hvol(fun=H2)

#H2_vol(c(0,1),c(0,1))

z2<-outer(x,y,FUN="H2")

if(0){
wireframe(z2, drape=TRUE)
wireframe(z2, drape=TRUE,screen=list(z=30, x=-60))
wireframe(z2, drape=TRUE,screen=list(z=20, x=-60))
wireframe(z2, drape=TRUE,screen=list(z=20, x=-80))
wireframe(z2, drape=TRUE,screen=list(z=30, x=-80))
}
```

The H-volume for $H(x,y)=(2x-1)(2y-1)$ is `r H2_vol(c(0,1),c(0,1))`, so this function is 2-increasing.

```{r ex2.2plta, cache=TRUE, fig.pos="center", fig.cap="Contour plot"}
contour(x,y,z2)
```

```{r ex2.2pltb, cache=TRUE, fig.pos="center", fig.cap="Color Image"}
image(x,y,z2,col=color)
```

```{r ex2.2pltc, cache=TRUE, fig.cap="Interactive Plot"}
z2col  <- cut(z2, num_col)
plotids<-persp3d(x,y,z2, col=color[z2col])
rglwidget(elementId = "plot3drgl")
```

### Ex 2.3

```{r ex2.3, cache=TRUE}
# make vectorized function
H3<-function(x,y) mapply(function(x,y) ((x+1)*(exp(y)-1))/(x+2*exp(y)-1), x,y)

# create H-volume function
H3_vol<-mk_Hvol(fun=H3)

#check 2-increasing
#H3_vol(c(-1,1),c(1e-15,500))

x3<-seq(-1,1,length=50)
y3<-seq(0,15,length=50)
z3<-outer(x3,y3,FUN="H3")

#H3(x3[4],y3[2])==z3[4,2]
```

```{r ex2.3plta, cache=TRUE}
contour(x3,y3,z3)
```

```{r ex2.3pltb, cache=TRUE}
image(x3,y3,z3,col=color)
```

```{r ex2.3pltc, cache=TRUE}
wireframe(z3, drape=TRUE, xlab="x", ylab="y")
wireframe(z3, drape=TRUE,screen=list(z=30, x=-60), xlab="x", ylab="y")
wireframe(z3, drape=TRUE,screen=list(z=20, x=-60), xlab="x", ylab="y")
```

```{r ex2.3pltd, cache=TRUE}
z3col  <- cut(z3, num_col)
persp3d(x3,y3,z3, col=color[z3col])
fn<-spin3d(axis = c(0, 0, 1), rpm = 6)

rglwidget() %>% playwidget(par3dinterpControl(fn, 0, 10, steps=25),
       step = 0.1, loop = TRUE, rate = 0.75)
```